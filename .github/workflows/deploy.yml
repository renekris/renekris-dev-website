name: Local Build & Deploy

on:
  push:
    branches: [main, dev]

jobs:
  local-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: |
        npm run lint
        npm test -- --coverage --watchAll=false

    - name: Build application
      run: npm run build

    - name: Set image tag
      id: tag
      run: |
        if [ "${{ github.ref_name }}" = "main" ]; then
          echo "tag=renekris-website:production-latest" >> $GITHUB_OUTPUT
          echo "service=production-website_web" >> $GITHUB_OUTPUT
        else
          echo "tag=renekris-website:staging-latest" >> $GITHUB_OUTPUT
          echo "service=staging-website_web" >> $GITHUB_OUTPUT
        fi

    - name: Build Docker image locally
      run: |
        docker build -t ${{ steps.tag.outputs.tag }} .
        echo "✅ Built Docker image: ${{ steps.tag.outputs.tag }}"

    - name: Deploy to Docker Swarm
      run: |
        docker service update --image ${{ steps.tag.outputs.tag }} ${{ steps.tag.outputs.service }}
        echo "✅ Updated service: ${{ steps.tag.outputs.service }}"

    - name: Health check
      run: |
        echo "⏳ Waiting for deployment..."
        sleep 30
        if [ "${{ github.ref_name }}" = "main" ]; then
          URL="https://renekris.dev/health"
        else
          URL="https://staging.renekris.dev/health"
        fi

        for i in {1..5}; do
          if curl -f "$URL"; then
            echo "✅ Deployment successful!"
            exit 0
          fi
          sleep 15
        done
        echo "❌ Health check failed"
        exit 1