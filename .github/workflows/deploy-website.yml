name: Deploy Website

on:
  push:
    branches: [ main, dev ]
    paths-ignore:
      - 'README.md'
      - '.github/**'

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH for private repository access
      run: |
        echo "üîë Setting up SSH authentication for private repositories..."
        
        # Ensure SSH directory exists
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Ensure SSH agent is running and keys are loaded
        eval "$(ssh-agent -s)"
        
        # Add GitHub to known hosts if not already present
        if ! ssh-keygen -F github.com > /dev/null; then
          echo "üìã Adding GitHub to known hosts..."
          ssh-keyscan -t rsa,ed25519 github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
        fi
        
        # Test SSH connection to GitHub
        echo "üîç Testing SSH connection to GitHub..."
        ssh -T git@github.com || true  # This will always "fail" but shows connection works
    
    - name: Determine deployment environment
      id: env
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
          echo "STACK_FILE=docker-stack-traefik.yml" >> $GITHUB_OUTPUT
          echo "STACK_NAME=renekris-stack" >> $GITHUB_OUTPUT
          echo "SERVICE_NAME=renekris-web" >> $GITHUB_OUTPUT
          echo "HOST_HEADER=renekris.dev" >> $GITHUB_OUTPUT
        else
          echo "ENVIRONMENT=staging" >> $GITHUB_OUTPUT
          echo "STACK_FILE=docker-stack-staging.yml" >> $GITHUB_OUTPUT
          echo "STACK_NAME=renekris-staging" >> $GITHUB_OUTPUT
          echo "SERVICE_NAME=renekris-staging" >> $GITHUB_OUTPUT
          echo "HOST_HEADER=staging.renekris.dev" >> $GITHUB_OUTPUT
        fi
    
    - name: Deploy to ${{ steps.env.outputs.ENVIRONMENT }}
      run: |
        echo "üöÄ Starting automated deployment to ${{ steps.env.outputs.ENVIRONMENT }}..."
        echo "üì¶ Building Docker image for branch: ${{ github.ref_name }}"
        
        # Generate unique build identifier
        TIMESTAMP_ID="$(date +%s)"
        BUILD_ID="${{ github.ref_name }}-${TIMESTAMP_ID}"
        COMMIT_HASH="${{ github.sha }}"
        
        # Ensure infrastructure repo is up to date
        echo "üì• Updating infrastructure repository..."
        cd /opt/renekris-infrastructure
        git fetch origin
        git reset --hard origin/main
        
        # Ensure website repo is up to date with the exact commit being deployed
        echo "üì• Updating website repository to commit: ${{ github.sha }}"
        cd /opt/renekris-dev-website
        git fetch origin
        git checkout ${{ github.sha }}
        
        # Build Docker image from the checked out commit
        echo "üî® Building Docker image from commit: ${{ github.sha }}"
        docker build --no-cache -t renekris-web:${BUILD_ID} .
        
        # Generate stack file with dynamic image tag
        cd /opt/renekris-infrastructure
        ./generate-stack-files.sh ${{ steps.env.outputs.ENVIRONMENT }} ${{ github.ref_name }} ${TIMESTAMP_ID}
        
        echo "üîÑ Deploying with image: renekris-web:${BUILD_ID}"
        
        # Deploy using generated stack file
        docker stack deploy -c ${{ steps.env.outputs.STACK_FILE }} ${{ steps.env.outputs.STACK_NAME }}
        
        # Force service update to ensure new image is used (Docker Swarm fix)
        echo "üîÑ Ensuring service uses new image..."
        if [ "${{ steps.env.outputs.ENVIRONMENT }}" = "staging" ]; then
          docker service update --image renekris-web:${BUILD_ID} renekris-staging_web-staging || echo "‚ö†Ô∏è Force update failed, but deployment may still work"
        else
          docker service update --image renekris-web:${BUILD_ID} renekris-stack_web || echo "‚ö†Ô∏è Force update failed, but deployment may still work"
        fi
        
        echo "üìù Deployment completed with image tag: ${BUILD_ID}"
    
    - name: Verify ${{ steps.env.outputs.ENVIRONMENT }} deployment
      run: |
        echo "üîç Verifying deployment to ${{ steps.env.outputs.ENVIRONMENT }}..."
        
        # Wait for service to stabilize (longer wait for Docker Swarm rolling updates)
        echo "‚è≥ Waiting for services to stabilize and rolling update to complete..."
        if [ "${{ steps.env.outputs.ENVIRONMENT }}" = "staging" ]; then
          sleep 45
        else
          sleep 60
        fi
        
        # Verify service is using the correct image
        echo "üîç Verifying service image deployment..."
        if [ "${{ steps.env.outputs.ENVIRONMENT }}" = "staging" ]; then
          DEPLOYED_IMAGE=$(docker service inspect renekris-staging_web-staging --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' 2>/dev/null)
        else
          DEPLOYED_IMAGE=$(docker service inspect renekris-stack_web --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' 2>/dev/null)
        fi
        
        EXPECTED_IMAGE="renekris-web:${{ github.ref_name }}-$(date +%s | head -c10)"
        echo "Expected image pattern: renekris-web:${{ github.ref_name }}-[timestamp]"
        echo "Deployed image: $DEPLOYED_IMAGE"
        
        # Check container status
        echo "üìã Container Status:"
        docker ps --filter name=${{ steps.env.outputs.SERVICE_NAME }} --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
        
        # Test health endpoint (using HTTPS to avoid redirect issues)
        echo "üè• Testing health endpoint..."
        if curl -f -k -H 'Host: ${{ steps.env.outputs.HOST_HEADER }}' https://localhost/health > /dev/null; then
          echo "‚úÖ Health check passed"
        else
          echo "‚ùå Health check failed"
          exit 1
        fi
        
        # Test main page and check for build timestamp
        echo "üåê Testing main page and content freshness..."
        RESPONSE=$(curl -s -k -H 'Host: ${{ steps.env.outputs.HOST_HEADER }}' https://localhost/)
        
        echo "üìä Response Debug Info:"
        echo "   Response length: ${#RESPONSE}"
        echo "   First 200 characters:"
        echo "$RESPONSE" | head -c 200
        echo ""
        echo "   Looking for doctype pattern..."
        
        if echo "$RESPONSE" | grep -i -q "<!doctype html"; then
          echo "‚úÖ Main page is accessible and returns HTML"
        else
          echo "‚ùå Main page is not accessible or not returning HTML"
          echo "üîç Full response for debugging:"
          echo "$RESPONSE"
          exit 1
        fi
        
        # Check if build timestamp header is present (cache busting verification)
        BUILD_TIMESTAMP=$(curl -s -I -k -H 'Host: ${{ steps.env.outputs.HOST_HEADER }}' https://localhost/ | grep -i "x-build-timestamp" | cut -d' ' -f2- | tr -d '\r')
        
        if [ -n "$BUILD_TIMESTAMP" ]; then
          echo "‚úÖ Build timestamp header found: $BUILD_TIMESTAMP"
          echo "   This confirms cache busting is working"
        else
          echo "‚ö†Ô∏è  No build timestamp header found (this is expected for production)"
        fi
        
        # Verify Docker service is using the correct image
        if [ "${{ steps.env.outputs.ENVIRONMENT }}" = "staging" ]; then
          DEPLOYED_IMAGE=$(docker service inspect renekris-staging_web-staging --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' 2>/dev/null)
        else
          DEPLOYED_IMAGE=$(docker service inspect renekris-stack_web --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' 2>/dev/null)
        fi
        
        if echo "$DEPLOYED_IMAGE" | grep -q "renekris-web:"; then
          echo "‚úÖ Service is using correct image: $DEPLOYED_IMAGE"
        else
          echo "‚ö†Ô∏è  Could not verify deployed image or image format unexpected"
        fi
        
        echo ""
        echo "üéâ Deployment to ${{ steps.env.outputs.ENVIRONMENT }} completed successfully!"
        echo "üìä Deployment Summary:"
        echo "   Environment: ${{ steps.env.outputs.ENVIRONMENT }}"
        echo "   Host: ${{ steps.env.outputs.HOST_HEADER }}"
        echo "   Image: renekris-web:${{ github.ref_name }}-$(date +%s)"
        echo "   Status: ‚úÖ VERIFIED"