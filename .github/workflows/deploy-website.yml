name: Deploy Website

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - '.github/**'

jobs:
  deploy:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VM 106
      run: |
        cd /opt/renekris-infrastructure
        echo "🚀 Starting automated deployment..."
        ./deploy-website-compose.sh
    
    - name: Verify deployment
      run: |
        # Wait for service to stabilize
        sleep 10
        
        # Check container status
        docker ps --filter name=renekris-web --format "table {{.Names}}\t{{.Status}}"
        
        # Test health endpoint
        curl -f -H 'Host: renekris.dev' http://localhost/ > /dev/null && echo "✅ External health check passed" || echo "❌ Health check failed"